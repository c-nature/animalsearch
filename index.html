<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Kingdom Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Import both the title font (Lilita One) and the body font (Nunito) -->
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Set the default body font */
        body {
            font-family: 'Nunito', sans-serif;
            background-image: url('https://images.pexels.com/photos/1661179/pexels-photo-1661179.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
        /* Create a custom class for the title font with a complementary color outline/shadow */
        .font-title {
            font-family: 'Lilita One', cursive;
            /* A crisp white outline with an orange glow for light mode */
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0 0 10px #f97316, 0 0 20px #f97316;
        }
        /* Removed the .dark .font-title rule to force a single style */
        .card-hover-effect {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<!-- UPDATED: Removed dark mode classes to enforce the light-mode theme -->
<body class="bg-gray-100 text-gray-900">

    <!-- NEW: Navigation bar with links to Explore and My Collection -->
    <!-- UPDATED: Removed dark mode classes from navigation to enforce light-mode -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-4 bg-white/50 backdrop-blur-md shadow-lg flex justify-center space-x-4">
        <button id="nav-explorer" class="px-6 py-3 bg-teal-500 text-white font-semibold rounded-full shadow-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50 transform hover:-translate-y-1 transition-all duration-200">
            <i class="fas fa-search mr-2"></i> Explore
        </button>
        <button id="nav-collection" class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transform hover:-translate-y-1 transition-all duration-200">
            <i class="fas fa-bookmark mr-2"></i> My Collection
        </button>
    </nav>

    <div id="main-view" class="container mx-auto p-4 sm:p-6 lg:p-8 mt-20">
        <!-- UPDATED: Removed dark mode classes from the main content box to enforce light-mode -->
        <div class="max-w-3xl mx-auto bg-white/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
           
            <!-- Header -->
            <header class="text-center mb-8">
                <!-- Applied the new title font class -->
                <h1 class="text-5xl sm:text-6xl font-bold text-teal-600 font-title tracking-wider">Animal Kingdom Explorer</h1>
                <p class="mt-2 text-lg text-gray-700">Discover the wonders of the animal world!</p>
            </header>

            <!-- Search Bar -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row gap-4">
                    <!-- UPDATED: Removed dark mode classes from input field -->
                    <input type="text" id="animal-name" class="flex-grow w-full px-4 py-3 bg-white/70 border-2 border-teal-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-teal-500/50 transition" placeholder="Enter an animal name (e.g., Tiger)">
                    <button id="search-btn" class="w-full sm:w-auto px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50 transform hover:-translate-y-1 transition-all duration-200">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
            </div>
            </div>

            <!-- Loading Spinner -->
            <!-- UPDATED: Removed dark mode classes from loading spinner -->
            <div id="loader" class="text-center hidden my-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-teal-500"></div>
                <p class="mt-4 text-gray-600">Exploring the wild...</p>
            </div>

            <!-- Message Display -->
            <!-- UPDATED: Removed dark mode classes from message box -->
            <div id="message-box" class="text-center hidden my-8 p-4 bg-red-100 text-red-800 rounded-lg shadow"></div>


            <!-- Results Section -->
            <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Animal cards will be inserted here -->
            </div>

        </div>
    </div>
   
    <!-- My Collection View (NEW) -->
    <div id="collection-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8 mt-20">
        <!-- UPDATED: Removed dark mode classes from collection view -->
        <div class="max-w-5xl mx-auto bg-white/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
            <h2 class="text-4xl font-bold text-teal-600 font-title tracking-wider text-center mb-8">My Animal Collection</h2>
            <div id="collection-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Collection items will be rendered here -->
            </div>
            <p id="collection-message" class="text-center text-gray-600 mt-8"></p>
        </div>
    </div>


    <!-- Detail View -->
    <div id="detail-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8 mt-20">
           <!-- UPDATED: Removed dark mode classes from detail view -->
           <div class="max-w-5xl mx-auto bg-white/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
                <header class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <!-- Applied the new title font class -->
                    <h2 id="detail-title" class="text-4xl font-bold text-teal-600 font-title tracking-wider"></h2>
                    <div class="flex gap-4 items-center">
                        <button id="add-to-collection-btn" class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 hidden">
                             <i class="fas fa-plus mr-2"></i> Add to Collection
                        </button>
                        <button id="back-btn" class="px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                    </div>
                </header>
                <div id="detail-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Animal details will be inserted here -->
            </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-teal-700 mb-4">Photo Gallery</h3>
                    <div id="gallery-loader" class="text-center hidden my-8">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-teal-500"></div>
                        <p class="mt-4 text-gray-600">Fetching more photos...</p>
                    </div>
                    <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Gallery images will be inserted here -->
                    </div>
                </div>
            </div>
    </div>
    <audio id="mainClickSoundElement" preload="auto">
        <!-- Use a default click sound if needed -->
    </audio>

    <script type="module">
        console.log("Animal Explorer script started."); // New log to confirm script execution

        document.addEventListener('DOMContentLoaded', () => { // Wrapped in DOMContentLoaded
            // --- Element References ---
            const searchBtn = document.getElementById('search-btn');
            const animalNameInput = document.getElementById('animal-name');
            const resultsContainer = document.getElementById('results');
            const loader = document.getElementById('loader');
            const messageBox = document.getElementById('message-box');
            
            const navExplorerBtn = document.getElementById('nav-explorer');
            const mainView = document.getElementById('main-view');
            const detailView = document.getElementById('detail-view');
            const backBtn = document.getElementById('back-btn');
            const detailTitle = document.getElementById('detail-title');
            const detailContent = document.getElementById('detail-content');
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryLoader = document.getElementById('gallery-loader');

            // NEW: Collection elements
            const navCollectionBtn = document.getElementById('nav-collection');
            const collectionContainer = document.getElementById('collection-view');
            const collectionGrid = document.getElementById('collection-grid');
            const collectionMessage = document.getElementById('collection-message');
            const addToCollectionBtn = document.getElementById('add-to-collection-btn');
            
            const mainClickSoundElement = window.parent.document.getElementById('mainClickSoundElement');
            const playClickSound = () => { if(mainClickSoundElement) mainClickSoundElement.play(); };

            // --- State ---
            let lastSearchResults = [];
            let currentAnimal = null; // To hold the animal data for the detail view
            let comingFromCollection = false; // Flag to track view origin
            // --- API Configuration ---
            const BACKEND_BASE_URL = 'https://smartypantsbe.onrender.com'; 
            
            const wikipediaApiUrl = 'https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*';
            const commonsApiUrl = 'https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*';


            // --- Event Listeners ---
            searchBtn.addEventListener('click', searchForAnimal);
            animalNameInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') searchForAnimal();
            });

            // UPDATED: Back button logic to handle navigation from both main view and collection view
            backBtn.addEventListener('click', () => {
                playClickSound();
                detailView.classList.add('hidden');
                if (comingFromCollection) {
                    collectionContainer.classList.remove('hidden');
                    navExplorerBtn.classList.remove('active');
                    navCollectionBtn.classList.add('active');
                } else {
                    mainView.classList.remove('hidden');
                    navExplorerBtn.classList.add('active');
                    navCollectionBtn.classList.remove('active');
                }
                comingFromCollection = false; // Reset the flag
            });

            // Nav button event listeners
            navExplorerBtn.addEventListener('click', () => {
                playClickSound();
                mainView.classList.remove('hidden');
                collectionContainer.classList.add('hidden');
                detailView.classList.add('hidden');
                navExplorerBtn.classList.add('active');
                navCollectionBtn.classList.remove('active');
            });
            navCollectionBtn.addEventListener('click', async () => {
                playClickSound();
                mainView.classList.add('hidden');
                detailView.classList.add('hidden');
                collectionContainer.classList.remove('hidden');
                navExplorerBtn.classList.remove('active');
                navCollectionBtn.classList.add('active');
                await fetchUserCollection();
            });

            // UPDATED: Add to collection button click listener on detail view
            addToCollectionBtn.addEventListener('click', () => addAnimalToCollection(currentAnimal));
            
            /** Main function to trigger the animal search. */
            function searchForAnimal() {
                playClickSound();
                console.log("searchForAnimal function called."); // Log for search
                const animalName = animalNameInput.value.trim();
                if (!animalName) {
                    displayMessage('Please enter an animal name to start exploring!');
                    return;
                }
                // Removed Pexels API key check as it's now handled by the backend
                fetchAnimalData(animalName);
                comingFromCollection = false; // Ensure this is false on a new search
            }
            
            /** Main image fetching function for a single card image. Prioritizes Pexels (via backend), then Wikipedia. */
            async function fetchAnimalImage(animalName) {
                let imageUrl = null;
                try {
                    // Try Pexels first via backend proxy
                    const pexelsResponse = await fetch(`${BACKEND_BASE_URL}/api/pexels-images?query=${encodeURIComponent(`${animalName} animal`)}&per_page=5`);
                    if (pexelsResponse.ok) {
                        const pexelsData = await pexelsResponse.json();
                        imageUrl = findBestMatch(pexelsData.photos, animalName, photo => photo.alt, photo => photo.src.large, "Pexels");
                    } else {
                        console.warn(`Pexels proxy failed: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                    }
                } catch (error) {
                    console.error('Error fetching from Pexels proxy:', error);
                }
                
                // Fallback to Wikipedia if Pexels didn't find a good match or backend call failed
                if (!imageUrl) {
                    console.log('Pexels image not found or proxy failed, trying Wikipedia...');
                    imageUrl = await fetchWikipediaImages(animalName, 1, true); // findOne = true
                }
                return imageUrl;
            }
            
            /** Fetches multiple images for the gallery view from both Pexels (via backend) and Wikipedia. */
            async function fetchAllGalleryImages(animalName) {
                const pexelsImagesPromise = (async () => {
                    try {
                        const pexelsResponse = await fetch(`${BACKEND_BASE_URL}/api/pexels-images?query=${encodeURIComponent(`${animalName} animal`)}&per_page=10`);
                        if (pexelsResponse.ok) {
                            const pexelsData = await pexelsResponse.json();
                            const lowerCaseAnimalName = animalName.toLowerCase();
                            return pexelsData.photos
                                .filter(photo => (photo.alt || '').toLowerCase().includes(lowerCaseAnimalName))
                                .map(photo => photo.src.large);
                        } else {
                            console.warn(`Pexels proxy failed for gallery: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                            return [];
                        }
                } catch (error) {
                    console.error('Error fetching gallery from Pexels proxy:', error);
                    return [];
                }
                })();

                const wikipediaImagesPromise = fetchWikipediaImages(animalName, 10, false); // findOne = false

                const [pexelsImages, wikipediaImages] = await Promise.all([
                    pexelsImagesPromise,
                    wikipediaImagesPromise
                ]);

                // Combine and deduplicate images
                const allImages = [...(pexelsImages || []), ...(wikipediaImages || [])];
                const uniqueImages = [...new Set(allImages)]; // Remove duplicates
                return uniqueImages;
            }

            /**
             * Generates a list of potential Wikipedia search terms for a given animal name,
             * prioritizing exact matches, then common suffixes/removals, then disambiguation.
             * @param {string} animalName The original animal name.
             * @returns {string[]} An array of encoded search terms.
             */
            function getWikipediaSearchTerms(animalName) {
                const terms = new Set();
                const lowerCaseName = animalName.toLowerCase();

                // 1. Exact match
                terms.add(animalName);

                // 2. Add common animal type suffixes
                const commonSuffixes = [' fish', ' bird', ' snake', ' mammal', ' reptile', ' amphibian', ' insect', ' animal', ' Invertebrate', ' Chordata', ' Species', ' Insect', ' Arachnid'];
                for (const suffix of commonSuffixes) {
                    if (!lowerCaseName.endsWith(suffix)) { // Avoid "fish fish"
                        terms.add(animalName + suffix);
                    }
                }

                // 3. Remove common animal type suffixes if present
                for (const suffix of commonSuffixes) {
                    if (lowerCaseName.endsWith(suffix.trim())) { // Check for " fish" -> "fish"
                        const strippedName = animalName.substring(0, animalName.length - suffix.length).trim();
                        if (strippedName) terms.add(strippedName);
                    }
                }

                // 4. Add common disambiguation (e.g., "Barramundi (fish)")
                if (!lowerCaseName.includes('(')) { // Avoid adding disambiguation to already disambiguated terms
                    for (const suffix of commonSuffixes) {
                        const cleanSuffix = suffix.trim();
                        if (cleanSuffix) {
                            terms.add(`${animalName} (${cleanSuffix})`);
                            // Also try stripped name with disambiguation if original has suffix
                            if (lowerCaseName.endsWith(suffix.trim())) {
                                const strippedName = animalName.substring(0, animalName.length - suffix.length).trim(); // Corrected to use cleanSuffix
                                if (strippedName) terms.add(`${strippedName} (${cleanSuffix})`);
                            }
                        }
                    }
                }
                
                // Convert to array and encode
                return Array.from(terms).map(term => encodeURIComponent(term));
            }
            
            /** Fetches images from Wikipedia. Can return one or many. */
            async function fetchWikipediaImages(animalName, count, findOne) {
                const searchTerms = getWikipediaSearchTerms(animalName);
                let imageUrls = [];

                if (findOne) {
                    // For a single image (thumbnail) using pageimages property from Wikipedia
                    let imageUrl = null;
                    for (const queryTitle of searchTerms) {
                        const wikiPageUrl = `${wikipediaApiUrl}&prop=pageimages&pithumbsize=400&titles=${queryTitle}&redirects=1`;
                        try {
                            const response = await fetch(wikiPageUrl);
                            const data = await response.json();
                            const pages = data.query?.pages;
                            const pageId = pages ? Object.keys(pages)[0] : null;
                            const page = pageId ? pages[pageId] : null;

                            if (page && !page.missing && page.thumbnail?.source) {
                                imageUrl = page.thumbnail.source;
                                console.log(`Found single image on Wikipedia for ${animalName} (via "${decodeURIComponent(queryTitle)}" thumbnail): ${imageUrl}`);
                                break; // Found an image, stop trying other terms
                            }
                        } catch (error) {
                            console.error(`Error fetching single image from Wikipedia for "${decodeURIComponent(queryTitle)}":`, error);
                        }
                    }

                    // Fallback to Wikimedia Commons search if no thumbnail found from Wikipedia page
                    if (!imageUrl) {
                        console.log('Wikipedia page thumbnail not found, trying Wikimedia Commons for single image...');
                        // Use the original animalName for the Commons search, which has its own filtering
                        const searchUrl = `${commonsApiUrl}&list=search&srsearch=${encodeURIComponent(animalName)}&srnamespace=6&srlimit=20&srwhat=text&srprop=snippet`; 
                        try {
                            const searchResponse = await fetch(searchUrl);
                            if (!searchResponse.ok) { console.warn(`Wikimedia Commons search failed for single image: ${searchResponse.status}`); return null; }
                            const searchData = await searchResponse.json();
                            const searchResults = searchData.query?.search;

                            if (searchResults && searchResults.length > 0) {
                                const lowerCaseAnimalName = animalName.toLowerCase();
                                const keywords = lowerCaseAnimalName.split(' ').filter(k => k.length > 0);

                                const filteredResults = searchResults.filter(result => {
                                    const title = result.title.toLowerCase();
                                    // FIX: Corrected snippet access
                                    const snippet = result.snippet ? result.snippet.toLowerCase() : ''; 
                                    const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(result.title);
                                    
                                    const containsAllKeywords = keywords.every(keyword => 
                                        title.includes(keyword) || snippet.includes(keyword)
                                    );
                                    
                                    const isRelevant = (keywords.length > 1 && containsAllKeywords) || 
                                                             (keywords.length === 1 && (title.includes(keywords[0]) || snippet.includes(keywords[0])));

                                    return isImage && isRelevant && !processedTitles.has(result.title);
                                });
                                
                                filteredResults.forEach(res => {
                                    if (!processedTitles.has(res.title)) {
                                        allFilteredResults.push(res);
                                    }
                                });
                                if (allFilteredResults.length >= count) break; // Stop if we have enough
                            }
                        } catch (error) {
                            console.error(`Error fetching gallery images from Wikimedia Commons for query "${decodeURIComponent(query)}":`, error);
                        }
                    }
                    const imageTitlesToFetch = allFilteredResults
                        .slice(0, count) // Take only the desired 'count' after strict filtering
                        .map(result => encodeURIComponent(result.title))
                        .join('|');
                    if (imageTitlesToFetch) {
                        const infoUrl = `${commonsApiUrl}&prop=imageinfo&iiprop=url&titles=${imageTitlesToFetch}&redirects=1`;
                        try { // Added try-catch for infoResponse
                            const infoResponse = await fetch(infoUrl);
                            if (!infoResponse.ok) { console.warn(`Wikimedia Commons imageinfo failed: ${infoResponse.status}`); return []; }
                            const infoData = await infoResponse.json();
                            const infoPages = infoData.query?.pages;

                            if (infoPages) {
                                for (const infoPageId in infoPages) {
                                    const infoPage = infoPages[infoPageId];
                                    if (infoPage.imageinfo && infoPage.imageinfo[0]?.url) {
                                        imageUrls.push(infoPage.imageinfo[0].url);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching gallery image URLs from Wikimedia Commons:', error);
                        }
                    }
                    console.log(`Found ${imageUrls.length} gallery images from Wikimedia Commons for ${animalName}.`);
                    return imageUrls;
                }
            }
