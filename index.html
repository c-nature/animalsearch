<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Kingdom Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Import both the title font (Lilita One) and the body font (Nunito) -->
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti.js library (for standalone badge notifications) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* Set the default body font */
        body {
            font-family: 'Nunito', sans-serif;
            background-image: url('https://images.pexels.com/photos/1661179/pexels-photo-1661179.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
        /* Create a custom class for the title font with a complementary color outline/shadow */
        .font-title {
            font-family: 'Lilita One', cursive;
            /* A crisp white outline with an orange glow for light mode */
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0 0 10px #f97316, 0 0 20px #f97316;
        }
        /* A different shadow for dark mode to ensure visibility */
        .dark .font-title {
           /* A crisp dark outline with a brighter orange glow for dark mode */
           text-shadow: -1px -1px 0 #0f766e, 1px -1px 0 #0f766e, -1px 1px 0 #0f766e, 1px 1px 0 #0f766e, 0 0 12px #fb923c, 0 0 22px #fb923c;
        }
        .card-hover-effect {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        /* --- Styles for the standalone badge notification pop-up --- */
        #badge-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 2000;
            text-align: center;
            font-family: 'Lilita One', cursive;
        }
        #badge-notification.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #badge-notification h2, #badge-notification p {
            color: white;
            text-shadow: 
                -2px -2px 0 #000, 2px -2px 0 #000, 
                -2px 2px 0 #000, 2px 2px 0 #000, 
                4px 4px 8px rgba(0,0,0,0.6);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="main-view" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-3xl mx-auto bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
            
            <!-- Header -->
            <header class="text-center mb-8">
                <!-- Applied the new title font class -->
                <h1 class="text-5xl sm:text-6xl font-bold text-teal-600 dark:text-teal-400 font-title tracking-wider">Animal Kingdom Explorer</h1>
                <p class="mt-2 text-lg text-gray-700 dark:text-gray-300">Discover the wonders of the animal world!</p>
            </header>

            <!-- Search Bar -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="animal-name" class="flex-grow w-full px-4 py-3 bg-white/70 dark:bg-gray-800/70 border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-4 focus:ring-teal-500/50 transition" placeholder="Enter an animal name (e.g., Tiger)">
                    <button id="search-btn" class="w-full sm:w-auto px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50 transform hover:-translate-y-1 transition-all duration-200">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loader" class="text-center hidden my-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-teal-500"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Exploring the wild...</p>
            </div>

            <!-- Message Display -->
            <div id="message-box" class="text-center hidden my-8 p-4 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-lg shadow"></div>


            <!-- Results Section -->
            <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Animal cards will be inserted here -->
            </div>

        </div>
    </div>
    
    <!-- My Collection View (NEW) -->
    <div id="collection-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-5xl mx-auto bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
            <h2 class="text-4xl font-bold text-teal-600 dark:text-teal-400 font-title tracking-wider text-center mb-8">My Animal Collection</h2>
            <div id="collection-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Collection items will be rendered here -->
            </div>
            <p id="collection-message" class="text-center text-gray-600 dark:text-gray-400 mt-8"></p>
        </div>
    </div>


    <!-- Detail View -->
    <div id="detail-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
           <div class="max-w-5xl mx-auto bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl">
                <header class="flex justify-between items-center mb-8">
                    <h2 id="detail-title" class="text-4xl font-bold text-teal-600 dark:text-teal-400 font-title tracking-wider"></h2>
                    <div class="flex gap-4 items-center">
                        <button id="add-to-collection-btn" class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 hidden">
                             <i class="fas fa-plus mr-2"></i> Add to Collection
                        </button>
                        <button id="back-btn" class="px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Results
                        </button>
                    </div>
                </header>
                <div id="detail-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Animal details will be inserted here -->
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-teal-700 dark:text-teal-300 mb-4">Photo Gallery</h3>
                    <div id="gallery-loader" class="text-center hidden my-8">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-teal-500"></div>
                        <p class="mt-4 text-gray-600 dark:text-gray-400">Fetching more photos...</p>
                    </div>
                    <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Gallery images will be inserted here -->
                    </div>
                </div>
            </div>
    </div>

    <!-- Standalone Badge Notification Pop-up -->
    <div id="badge-notification" class="hidden flex flex-col items-center">
        <h2 class="text-3xl font-bold text-yellow-300 mb-4">New Badge Unlocked!</h2>
        <img id="badge-notification-img" src="" alt="New Badge" class="w-48 h-48 mb-4">
        <p id="badge-notification-name" class="text-2xl text-white font-semibold"></p>
    </div>

    <!-- Badge Sound Effect -->
    <audio id="badgeSoundElement" preload="auto">
        <!-- CORRECTED: Use a URL that's relative to the main domain for better compatibility -->
        <source src="../badge.wav" type="audio/wav">
    </audio>


    <script type="module">
        console.log("Animal Explorer script started.");

        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const searchBtn = document.getElementById('search-btn');
            const animalNameInput = document.getElementById('animal-name');
            const resultsContainer = document.getElementById('results');
            const loader = document.getElementById('loader');
            const messageBox = document.getElementById('message-box');
            
            const mainView = document.getElementById('main-view');
            const detailView = document.getElementById('detail-view');
            const backBtn = document.getElementById('back-btn');
            const detailTitle = document.getElementById('detail-title');
            const detailContent = document.getElementById('detail-content');
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryLoader = document.getElementById('gallery-loader');

            // NEW: Collection elements
            const collectionContainer = document.getElementById('collection-view');
            const collectionGrid = document.getElementById('collection-grid');
            const collectionMessage = document.getElementById('collection-message');
            const addToCollectionBtn = document.getElementById('add-to-collection-btn');
            
            const mainClickSoundElement = window.parent.document.getElementById('mainClickSoundElement');
            const playClickSound = () => { if(mainClickSoundElement) mainClickSoundElement.play(); };

            // --- State ---
            let lastSearchResults = [];
            let currentAnimal = null;
            // CORRECTED: This variable is now set dynamically from the URL parameters.
            let BACKEND_BASE_URL = ''; 
            let USER_ID = null;
            let AUTH_TOKEN = null;


            // --- Badge Awarding Logic ---
            function showBadgeNotification(badgeName, badgeDisplayName) {
                const badgeNotification = document.getElementById('badge-notification');
                const badgeNotificationImg = document.getElementById('badge-notification-img');
                const badgeNotificationName = document.getElementById('badge-notification-name');
                const badgeSoundElement = document.getElementById('badgeSoundElement');

                if (badgeSoundElement) {
                    badgeSoundElement.currentTime = 0;
                    badgeSoundElement.play().catch(e => console.warn("Error playing badge sound:", e));
                }
                if (typeof confetti === 'function') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
                // CORRECTED: Badge image URL is now relative to the current host
                badgeNotificationImg.src = `Badges/${badgeName}.png`;
                badgeNotificationName.textContent = badgeDisplayName;
                badgeNotification.classList.remove('hidden');
                setTimeout(() => { badgeNotification.classList.add('show'); }, 10);
                setTimeout(() => {
                    badgeNotification.classList.remove('show');
                    setTimeout(() => { badgeNotification.classList.add('hidden'); }, 500);
                }, 4000);
            }

            async function awardBadge(badgeName, badgeDisplayName) {
                if (!BACKEND_BASE_URL) {
                    console.error("Cannot award badge: Backend URL not set.");
                    return;
                }
                const userString = localStorage.getItem('user');
                const token = localStorage.getItem('token');
                
                if (!token || !userString) {
                    console.log("Badge Award: User not logged in.");
                    return;
                }
                
                const user = JSON.parse(userString);
                // Check if user already has the badge in localStorage to prevent unnecessary API calls
                if (user.badges && user.badges.includes(badgeName)) {
                    console.log(`Badge '${badgeName}' already awarded.`);
                    // If the user has it, just show the animation and don't make the API call.
                    showBadgeNotification(badgeName, badgeDisplayName);
                    return;
                }

                try {
                    const response = await fetch(`${BACKEND_BASE_URL}/award-badge`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ userId: user._id, badgeName: badgeName })
                    });

                    const result = await response.json();

                    if (result.status === "Success" && !result.alreadyAwarded) {
                        // Update the user object in localStorage with the new badge list
                        user.badges = result.data.badges;
                        localStorage.setItem('user', JSON.stringify(user));

                        // Show a notification
                        showBadgeNotification(badgeName, badgeDisplayName);
                        
                        // Optionally, update the profile view if it's open
                        if (window.parent && window.parent.updateAuthButtons) {
                            window.parent.updateAuthButtons();
                        }
                    } else {
                        console.log("Badge already awarded or other error.", result.message);
                    }
                } catch (error) {
                    console.error("Error awarding badge:", error);
                }
            }


            // --- Event Listeners ---
            searchBtn.addEventListener('click', searchForAnimal);
            animalNameInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') searchForAnimal();
            });
            backBtn.addEventListener('click', () => {
                playClickSound();
                detailView.classList.add('hidden');
                if (mainView.classList.contains('hidden') && !collectionContainer.classList.contains('hidden')) {
                     collectionContainer.classList.remove('hidden');
                } else {
                    mainView.classList.remove('hidden');
                }
            });
            
            addToCollectionBtn.addEventListener('click', addAnimalToCollection);
            
            /** Main function to trigger the animal search. */
            function searchForAnimal() {
                playClickSound();
                console.log("searchForAnimal function called.");
                const animalName = animalNameInput.value.trim();
                if (!animalName) {
                    displayMessage('Please enter an animal name to start exploring!');
                    return;
                }
                fetchAnimalData(animalName);
            }
            
            /** Main image fetching function for a single card image. */
            async function fetchAnimalImage(animalName) {
                let imageUrl = null;
                try {
                    const pexelsResponse = await fetch(`${BACKEND_BASE_URL}/api/pexels-images?query=${encodeURIComponent(`${animalName} animal`)}&per_page=5`);
                    if (pexelsResponse.ok) {
                        const pexelsData = await pexelsResponse.json();
                        imageUrl = findBestMatch(pexelsData.photos, animalName, photo => photo.alt, photo => photo.src.large, "Pexels");
                    } else {
                        console.warn(`Pexels proxy failed: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                    }
                } catch (error) {
                    console.error('Error fetching from Pexels proxy:', error);
                }
                
                if (!imageUrl) {
                    console.log('Pexels image not found or proxy failed, trying Wikipedia...');
                    imageUrl = await fetchWikipediaImages(animalName, 1, true);
                }
                return imageUrl;
            }
            
            /** Fetches multiple images for the gallery view. */
            async function fetchAllGalleryImages(animalName) {
                const pexelsImagesPromise = (async () => {
                    try {
                        const pexelsResponse = await fetch(`${BACKEND_BASE_URL}/api/pexels-images?query=${encodeURIComponent(`${animalName} animal`)}&per_page=10`);
                        if (pexelsResponse.ok) {
                            const pexelsData = await pexelsResponse.json();
                            const lowerCaseAnimalName = animalName.toLowerCase();
                            return pexelsData.photos
                                .filter(photo => (photo.alt || '').toLowerCase().includes(lowerCaseAnimalName))
                                .map(photo => photo.src.large);
                        } else {
                            console.warn(`Pexels proxy failed for gallery: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                            return [];
                        }
                    } catch (error) {
                        console.error('Error fetching gallery from Pexels proxy:', error);
                        return [];
                    }
                })();

                const wikipediaImagesPromise = fetchWikipediaImages(animalName, 10, false);

                const [pexelsImages, wikipediaImages] = await Promise.all([
                    pexelsImagesPromise,
                    wikipediaImagesPromise
                ]);

                const allImages = [...(pexelsImages || []), ...(wikipediaImages || [])];
                const uniqueImages = [...new Set(allImages)];
                return uniqueImages;
            }

            /** Generates a list of potential Wikipedia search terms. */
            function getWikipediaSearchTerms(animalName) {
                const terms = new Set();
                const lowerCaseName = animalName.toLowerCase();
                terms.add(animalName);
                const commonSuffixes = [' fish', ' bird', ' snake', ' mammal', ' reptile', ' amphibian', ' insect', ' animal', ' Invertebrate', ' Chordata', ' Species', ' Insect', ' Arachnid'];
                for (const suffix of commonSuffixes) {
                    if (!lowerCaseName.endsWith(suffix)) {
                        terms.add(animalName + suffix);
                    }
                }
                for (const suffix of commonSuffixes) {
                    if (lowerCaseName.endsWith(suffix.trim())) {
                        const strippedName = animalName.substring(0, animalName.length - suffix.length).trim();
                        if (strippedName) terms.add(strippedName);
                    }
                }
                if (!lowerCaseName.includes('(')) {
                    for (const suffix of commonSuffixes) {
                        const cleanSuffix = suffix.trim();
                        if (cleanSuffix) {
                            terms.add(`${animalName} (${cleanSuffix})`);
                            if (lowerCaseName.endsWith(suffix.trim())) {
                                const strippedName = animalName.substring(0, cleanSuffix.length - cleanSuffix.length).trim();
                                if (strippedName) terms.add(`${strippedName} (${cleanSuffix})`);
                            }
                        }
                    }
                }
                return Array.from(terms).map(term => encodeURIComponent(term));
            }
            
            /** Fetches images from Wikipedia. */
            async function fetchWikipediaImages(animalName, count, findOne) {
                const wikipediaApiUrl = 'https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*';
                const commonsApiUrl = 'https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*';

                const searchTerms = getWikipediaSearchTerms(animalName);
                let imageUrls = [];

                if (findOne) {
                    let imageUrl = null;
                    for (const queryTitle of searchTerms) {
                        const wikiPageUrl = `${wikipediaApiUrl}&prop=pageimages&pithumbsize=400&titles=${queryTitle}&redirects=1`;
                        try {
                            const response = await fetch(wikiPageUrl);
                            const data = await response.json();
                            const pages = data.query?.pages;
                            const pageId = pages ? Object.keys(pages)[0] : null;
                            const page = pageId ? pages[pageId] : null;

                            if (page && !page.missing && page.thumbnail?.source) {
                                imageUrl = page.thumbnail.source;
                                console.log(`Found single image on Wikipedia for ${animalName} (via "${decodeURIComponent(queryTitle)}" thumbnail): ${imageUrl}`);
                                break;
                            }
                        } catch (error) {
                            console.error(`Error fetching single image from Wikipedia for "${decodeURIComponent(queryTitle)}":`, error);
                        }
                    }
                    if (!imageUrl) {
                        console.log('Wikipedia page thumbnail not found, trying Wikimedia Commons for single image...');
                        const searchUrl = `${commonsApiUrl}&list=search&srsearch=${encodeURIComponent(animalName)}&srnamespace=6&srlimit=20&srwhat=text&srprop=snippet`; 
                        try {
                            const searchResponse = await fetch(searchUrl);
                            if (!searchResponse.ok) { console.warn(`Wikimedia Commons search failed for single image: ${searchResponse.status}`); return null; }
                            const searchData = await searchResponse.json();
                            const searchResults = searchData.query?.search;

                            if (searchResults && searchResults.length > 0) {
                                const lowerCaseAnimalName = animalName.toLowerCase();
                                const keywords = lowerCaseAnimalName.split(' ').filter(k => k.length > 0);
                                const filteredResults = searchResults.filter(result => {
                                    const title = result.title.toLowerCase();
                                    const snippet = result.snippet ? result.snippet.toLowerCase() : ''; 
                                    const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(result.title);
                                    const containsAllKeywords = keywords.every(keyword => 
                                        title.includes(keyword) || snippet.includes(keyword)
                                    );
                                    return isImage && containsAllKeywords;
                                });
                                if (filteredResults.length > 0) {
                                    const bestMatchTitle = encodeURIComponent(filteredResults[0].title);
                                    const infoUrl = `${commonsApiUrl}&prop=imageinfo&iiprop=url&titles=${bestMatchTitle}&redirects=1`;
                                    try {
                                        const infoResponse = await fetch(infoUrl);
                                        const infoData = await infoResponse.json();
                                        const infoPages = infoData.query?.pages;
                                        if (infoPages) {
                                            const infoPageId = Object.keys(infoPages)[0];
                                            const infoPage = infoPages[infoPageId];
                                            if (infoPage.imageinfo && infoPage.imageinfo[0]?.url) {
                                                imageUrl = infoPage.imageinfo[0].url;
                                                console.log(`Found single image on Wikimedia Commons for ${animalName}: ${imageUrl}`);
                                            }
                                        }
                                    } catch (error) {
                                        console.error('Error fetching image info from Wikimedia Commons:', error);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching single image from Wikimedia Commons:', error);
                        }
                    }
                    return imageUrl;
                } else {
                    let allFilteredResults = [];
                    const processedTitles = new Set();
                    for (const query of searchTerms) {
                        const searchUrl = `${commonsApiUrl}&list=search&srsearch=${query}&srnamespace=6&srlimit=${count * 3}&srwhat=text&srprop=snippet`; 
                        try {
                            const searchResponse = await fetch(searchUrl);
                            if (!searchResponse.ok) { console.warn(`Wikimedia Commons search failed for query "${decodeURIComponent(query)}": ${searchResponse.status}`); continue; }
                            const searchData = await searchResponse.json();
                            const searchResults = searchData.query?.search;

                            if (searchResults && searchResults.length > 0) {
                                const lowerCaseAnimalName = animalName.toLowerCase();
                                const keywords = lowerCaseAnimalName.split(' ').filter(k => k.length > 0);
                                const filteredResults = searchResults.filter(result => {
                                    const title = result.title.toLowerCase();
                                    const snippet = result.snippet ? result.snippet.toLowerCase() : ''; 
                                    const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(result.title);
                                    const containsAllKeywords = keywords.every(keyword => 
                                        title.includes(keyword) || snippet.includes(keyword)
                                    );
                                    const isRelevant = (keywords.length > 1 && containsAllKeywords) || 
                                                     (keywords.length === 1 && (title.includes(keywords[0]) || snippet.includes(keywords[0])));
                                    return isImage && isRelevant && !processedTitles.has(result.title);
                                });
                                
                                filteredResults.forEach(res => {
                                    if (!processedTitles.has(res.title)) {
                                        allFilteredResults.push(res);
                                        processedTitles.add(res.title);
                                    }
                                });

                                if (allFilteredResults.length >= count) break;
                            }
                        } catch (error) {
                            console.error(`Error fetching gallery images from Wikimedia Commons for query "${decodeURIComponent(query)}":`, error);
                        }
                    }
                    const imageTitlesToFetch = allFilteredResults
                        .slice(0, count)
                        .map(result => encodeURIComponent(result.title))
                        .join('|');
                    if (imageTitlesToFetch) {
                        const infoUrl = `${commonsApiUrl}&prop=imageinfo&iiprop=url&titles=${imageTitlesToFetch}&redirects=1`;
                        try {
                            const infoResponse = await fetch(infoUrl);
                            if (!infoResponse.ok) { console.warn(`Wikimedia Commons imageinfo failed: ${infoResponse.status}`); return []; }
                            const infoData = await infoResponse.json();
                            const infoPages = infoData.query?.pages;
                            if (infoPages) {
                                for (const infoPageId in infoPages) {
                                    const infoPage = infoPages[infoPageId];
                                    if (infoPage.imageinfo && infoPage.imageinfo[0]?.url) {
                                        imageUrls.push(infoPage.imageinfo[0].url);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching gallery image URLs from Wikimedia Commons:', error);
                        }
                    }
                    console.log(`Found ${imageUrls.length} gallery images from Wikimedia Commons for ${animalName}.`);
                    return imageUrls;
                }
            }

            /** Generic helper function to find the best single image match from a list of results. */
            function findBestMatch(photos, animalName, getAltText, getImageUrl, sourceName) {
                if (!photos || photos.length === 0) return null;
                const lowerCaseAnimalName = animalName.toLowerCase();
                for (const photo of photos) {
                    const altText = (getAltText(photo) || '').toLowerCase();
                    if (altText.includes(lowerCaseAnimalName)) {
                        console.log(`Found matching image on ${sourceName} with alt/tags: "${altText}"`);
                        return getImageUrl(photo);
                    }
                }
                return null;
            }

            /** Fetches animal data from the API Ninjas endpoint via backend proxy. */
            async function fetchAnimalData(animalName) {
                if (!BACKEND_BASE_URL) {
                    displayMessage('Error: Backend server URL is not set.');
                    console.error('Backend URL is not defined.');
                    return;
                }

                loader.classList.remove('hidden');
                resultsContainer.innerHTML = '';
                hideMessage();
                try {
                    const response = await fetch(`${BACKEND_BASE_URL}/api/animals?name=${encodeURIComponent(animalName)}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorData.message || response.statusText}`);
                    }
                    const data = await response.json();
                    
                    const user = JSON.parse(localStorage.getItem('user'));
                    const hasBadge = user && user.badges && user.badges.includes('firstsearchanimalexplorer');
                    
                    if (data.length > 0 && !hasBadge) {
                        awardBadge('firstsearchanimalexplorer', 'First Search Animal Explorer');
                    }

                    if (data.length === 0) {
                        console.log(`API-Ninjas proxy found no data for "${animalName}". Attempting Wikipedia fallback.`);
                        const wikipediaAnimal = await fetchWikipediaAnimalDetails(animalName);
                        if (wikipediaAnimal) {
                            lastSearchResults = [wikipediaAnimal];
                            await displayResults(lastSearchResults);
                        } else {
                            displayMessage('We searched far and wide but couldn\'t find such a creature. Try another one!');
                        }
                    } else {
                        const enrichedData = await Promise.all(data.map(async (animal) => {
                            const wikipediaDetails = await fetchWikipediaAnimalDetails(animal.name);
                            if (wikipediaDetails) {
                                const mergedCharacteristics = {};
                                for (const key in wikipediaDetails.characteristics) {
                                    mergedCharacteristics[key] = wikipediaDetails.characteristics[key];
                                }
                                for (const key in animal.characteristics) {
                                    if (animal.characteristics[key] && animal.characteristics[key].toString().trim() !== '' && animal.characteristics[key].toString().toLowerCase() !== 'not specified') {
                                        mergedCharacteristics[key] = animal.characteristics[key];
                                    }
                                }
                                return {
                                    ...animal,
                                    characteristics: mergedCharacteristics,
                                    locations: (animal.locations && animal.locations.length > 0 && animal.locations[0].toString().toLowerCase() !== 'not specified') ? animal.locations : wikipediaDetails.locations,
                                    wikipedia_url: wikipediaDetails.wikipedia_url
                                };
                            }
                            return animal;
                        }));
                        lastSearchResults = enrichedData;
                        await displayResults(enrichedData);
                    }
                } catch (error) {
                    console.error('Error fetching animal data:', error);
                    displayMessage(`Oops! Couldn't fetch data: ${error.message}. Please try again.`);
                } finally {
                    loader.classList.add('hidden');
                }
            }
            
            const getUserId = () => {
                const user = JSON.parse(localStorage.getItem('user'));
                return user ? user._id : null;
            };

            async function fetchUserCollection() {
                const userId = getUserId();
                if (!userId) {
                    collectionMessage.textContent = "Please log in on the main SmartyPants website to view your collection.";
                    collectionGrid.innerHTML = '';
                    return;
                }
                collectionMessage.textContent = "Fetching your collection...";
                try {
                    const response = await fetch(`${BACKEND_BASE_URL}/api/user/collection/${userId}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Could not fetch collection.');
                    }
                    const data = await response.json();
                    if (data.status === 'Success') {
                        const animalCollection = data.data.filter(item => item.isAnimal);
                        if (animalCollection.length > 0) {
                            renderCollectionItems(animalCollection);
                        } else {
                            collectionMessage.textContent = "Your animal collection is empty.";
                            collectionGrid.innerHTML = '';
                        }
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error("Error fetching collection:", error);
                    collectionMessage.textContent = `Error fetching collection: ${error.message}`;
                }
            }
            
            async function addAnimalToCollection() {
                 playClickSound();
                 if (!currentAnimal) {
                     window.parent.showMessageBox("No animal selected to add.");
                     return;
                 }
                 const userId = getUserId();
                 if (!userId) {
                     window.parent.showMessageBox("Please log in on the main SmartyPants website to add to collection.");
                     return;
                 }
                
                 const animalDataForCollection = {
                     ...currentAnimal,
                     isAnimal: true 
                 };

                 try {
                     const response = await fetch(`${BACKEND_BASE_URL}/api/user/collection/add`, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             userId: userId,
                             plantData: animalDataForCollection
                         })
                     });
                     const result = await response.json();
                     if (result.status === 'Success') {
                         window.parent.showMessageBox("Animal added to your collection!");
                         const user = JSON.parse(localStorage.getItem('user'));
                         const hasBadge = user && user.badges && user.badges.includes('firstanimaladdedtocollection');

                         if (window.parent && window.parent.awardBadge && !hasBadge) {
                             window.parent.awardBadge('firstanimaladdedtocollection', 'First Animal Added to Collection');
                         }
                     } else {
                         throw new Error(result.message);
                     }
                 } catch (error) {
                     console.error("Error adding animal to collection:", error);
                     window.parent.showMessageBox(`Error adding animal: ${error.message}`);
                 }
            }


            /** Displays the fetched animal data on the page. */
            async function displayResults(animals) {
                resultsContainer.innerHTML = '';
                if (animals.length === 0) {
                    displayMessage('No animals found with that name. Try another one!');
                    return;
                }
                
                for (const animal of animals) {
                    const card = document.createElement('div');
                    card.className = 'bg-gradient-to-br from-white/90 to-gray-100/90 dark:from-gray-800/90 dark:to-gray-900/90 rounded-xl shadow-lg overflow-hidden flex flex-col card-hover-effect';
                    
                    const name = animal.name || 'N/A';
                    const scientificName = animal.taxonomy?.scientific_name || 'N/A';
                    const diet = animal.characteristics?.diet || 'Not specified';
                    const lifespan = animal.characteristics?.lifespan || 'Not specified';
                    const habitat = animal.characteristics?.habitat || 'Not specified';
                    const locations = (animal.locations && animal.locations.length > 0 && animal.locations[0].toString().toLowerCase() !== 'not specified') ? animal.locations.join(', ') : 'Not specified';
                    const wikipediaUrl = animal.wikipedia_url || `https://en.wikipedia.org/wiki/${encodeURIComponent(name)}`;


                    const imageUrl = await fetchAnimalImage(name);
                    let imageContainer;
                    if (imageUrl) {
                        imageContainer = document.createElement('div'); 
                        imageContainer.className = 'block';
                        imageContainer.innerHTML = `<img src="${imageUrl}" alt="Photo of a ${name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e0e0/555555?text=Image+Not+Found';">`;
                    } else {
                        imageContainer = document.createElement('div');
                        imageContainer.className = 'w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center';
                        imageContainer.innerHTML = `<i class="fas fa-image fa-3x text-gray-400"></i><p class="ml-2 text-gray-500">No Image</p>`;
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-6 flex-grow';
                    contentDiv.innerHTML = `
                        <a href="#" class="cursor-pointer" data-animal-name="${name}">
                            <h2 class="text-2xl font-bold text-teal-700 dark:text-teal-300 mb-2 hover:underline">${name}</h2>
                        </a>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-5 italic">${scientificName}</p>
                        <div class="space-y-4 text-gray-800 dark:text-gray-200">
                            <p><i class="fas fa-utensils w-6 text-yellow-500"></i> <strong class="font-semibold">Diet:</strong> ${diet}</p>
                            <p><i class="fas fa-map-marker-alt w-6 text-red-500"></i> <strong class="font-semibold">Locations:</strong> ${locations}</p>
                            <p><i class="fas fa-heartbeat w-6 text-green-500"></i> <strong class="font-semibold">Lifespan:</strong> ${lifespan}</p>
                            <p><i class="fas fa-home w-6 text-indigo-500"></i> <strong class="font-semibold">Habitat:</strong> ${habitat}</p>
                        </div>
                    `;
                    
                    card.appendChild(imageContainer);
                    card.appendChild(contentDiv);
                    resultsContainer.appendChild(card);
                }
                
                document.querySelectorAll('[data-animal-name]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        playClickSound();
                        e.preventDefault();
                        const animalName = e.currentTarget.getAttribute('data-animal-name');
                        const animalData = lastSearchResults.find(animal => animal.name === animalName);
                        if (animalData) {
                            currentAnimal = animalData;
                            showDetailView(animalData);
                        }
                    });
                });
            }
            
            async function renderCollectionItems(animals) {
                collectionGrid.innerHTML = '';
                 if (animals.length === 0) {
                    collectionMessage.textContent = 'Your collection is empty.';
                    return;
                }
                collectionMessage.textContent = '';
                for (const animal of animals) {
                     const card = document.createElement('div');
                     card.className = 'bg-gradient-to-br from-white/90 to-gray-100/90 dark:from-gray-800/90 dark:to-gray-900/90 rounded-xl shadow-lg overflow-hidden flex flex-col card-hover-effect cursor-pointer';

                     const name = animal.name || 'N/A';
                     const scientificName = animal.taxonomy?.scientific_name || 'N/A';

                     card.innerHTML = `
                         <img src="${animal.imageUrl || 'https://placehold.co/400x300/e0e0e0/555555?text=Image+Not+Found'}" alt="Photo of a ${name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e0e0/555555?text=Image+Not+Found';">
                         <div class="p-6 flex-grow">
                             <h2 class="text-2xl font-bold text-teal-700 dark:text-teal-300 mb-2">${name}</h2>
                             <p class="text-sm text-gray-500 dark:text-gray-400 font-medium italic">${scientificName}</p>
                         </div>
                     `;
                     
                     card.addEventListener('click', () => {
                         playClickSound();
                         currentAnimal = animal;
                         showDetailView(animal);
                     });
                     
                     collectionGrid.appendChild(card);
                }
            }


            /** Fetches basic animal details from Wikipedia. */
            async function fetchWikipediaAnimalDetails(animalName) {
                const wikipediaApiUrl = 'https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*';
                const searchTerms = getWikipediaSearchTerms(animalName); 
                const animalCategoryKeywords = [
                    'animal', 'animals', 'mammals', 'fish', 'birds', 'reptiles', 'amphibians', 
                    'insects', 'arachnids', 'crustaceans', 'molluscs', 'vertebrates', 'chordata', 'invertebrates', 
                    'species', 'genera', 'families', 'orders', 'classes', 'phyla', 'kingdom animalia'
                ];

                for (const queryTitle of searchTerms) {
                    const url = `${wikipediaApiUrl}&prop=extracts|pageprops|info|categories&exintro=1&explaintext=1&redirects=1&titles=${queryTitle}&inprop=url&cllimit=500`;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            console.warn(`Wikipedia API (animal details) failed for "${decodeURIComponent(queryTitle)}": ${response.status}`);
                            continue; 
                        }
                        const data = await response.json();
                        const pages = data.query?.pages;

                        if (pages) {
                            const pageId = Object.keys(pages)[0];
                            const page = pages[pageId];

                            if (!page.missing) {
                                const description = page.extract || 'No detailed description available, this must be a rare find!';
                                const wikipediaUrl = page.fullurl || `https://en.wikipedia.org/wiki/${queryTitle}`;
                                let scientificName = 'N/A';
                                let diet = 'Not specified';
                                let lifespan = 'Not specified';
                                let habitat = 'Not specified';
                                let locations = ['Not specified'];

                                let isDefinitelyAnimal = false;
                                const categories = page.categories || [];
                                const lowerCaseDescription = description.toLowerCase();
                                const pageTitle = decodeURIComponent(queryTitle).toLowerCase(); 

                                isDefinitelyAnimal = categories.some(cat => {
                                    const catTitle = cat.title.toLowerCase();
                                    return animalCategoryKeywords.some(keyword => catTitle.includes(keyword));
                                });

                                if (!isDefinitelyAnimal) {
                                    const firstSentence = lowerCaseDescription.split('.')[0];
                                    const strongTextIndicators = [
                                        'is a species of', 'is a genus of', 'is a family of', 'is an order of', 'is a class of', 'is a phylum of', 
                                        'kingdom animalia', 'is an animal', 'is a mammal', 'is a bird', 'is a fish', 'is a reptile', 
                                        'is an amphibian', 'is an insect', 'vertebrate', 'invertebrate', 'wildlife', 'fauna', 'creature'
                                    ];
                                    isDefinitelyAnimal = strongTextIndicators.some(indicator => firstSentence.includes(indicator));
                                }

                                if (!isDefinitelyAnimal) {
                                    const originalNameKeywords = animalName.toLowerCase().split(' ').filter(k => k.length > 0);
                                    const originalNameInDescription = originalNameKeywords.every(keyword => lowerCaseDescription.includes(keyword));
                                    const originalNameInTitle = originalNameKeywords.every(keyword => pageTitle.includes(keyword));
                                    isDefinitelyAnimal = (originalNameInTitle && originalNameInDescription && lowerCaseDescription.length > 100);
                                }

                                const nonAnimalKeywords = [
                                    'disambiguation', 'may refer to', 'list of', 'human', 'person', 'organization', 'company', 'building', 
                                    'vehicle', 'plant', 'fungus', 'bacteria', 'virus', 'disease', 'concept', 'event', 'geographic',
                                    'software', 'music', 'film', 'book', 'art', 'history', 'mathematics', 'physics', 'chemistry',
                                    'engineering', 'technology', 'tool', 'weapon', 'food', 'drink', 'sport', 'game', 'toy', 'clothing',
                                    'material', 'chemical', 'element', 'compound', 'structure', 'geology', 'astronomy', 'celestial body',
                                    'mythology', 'fictional', 'character', 'album', 'song', 'television series', 'band', 'group',
                                    'school', 'bus', 'pencil', 'object', 'abstract', 'theory', 'system' 
                                ];
                                const containsStrongNonAnimalKeywords = nonAnimalKeywords.some(keyword => 
                                    pageTitle.includes(keyword) || lowerCaseDescription.includes(keyword)
                                );

                                const hasDirectAnimalCategory = categories.some(cat => animalCategoryKeywords.includes(cat.title.toLowerCase().replace('category:', '')));
                                if (isDefinitelyAnimal && containsStrongNonAnimalKeywords) {
                                    const hasDirectAnimalCategory = categories.some(cat => animalCategoryKeywords.includes(cat.title.toLowerCase().replace('category:', '')));
                                    if (!hasDirectAnimalCategory && containsStrongNonAnimalKeywords) {
                                        console.log(`Wikipedia page for "${animalName}" (via "${decodeURIComponent(queryTitle)}") contains non-animal keywords and no direct animal category. Skipping.`);
                                        continue;
                                    }
                                } else if (!isDefinitelyAnimal) {
                                    console.log(`Wikipedia page for "${animalName}" (via "${decodeURIComponent(queryTitle)}") does not meet animal criteria. Skipping.`);
                                    continue;
                                }

                                const scientificNameMatch = description.match(/\b([A-Z][a-z]+)\s([a-z]+)\b/);
                                if (scientificNameMatch && scientificNameMatch[0]) {
                                    scientificName = scientificNameMatch[0];
                                }

                                let dietMatch = lowerCaseDescription.match(/(?:diet is|eats|feeds on|primarily eats|omnivorous|carnivorous|herbivorous|insectivorous|piscivorous)(?: an?| the)?\s*([\w\s,.\-()]+?)(?:\.|\n|;|,|$)/i);
                                if (dietMatch && dietMatch[1]) {
                                    diet = dietMatch[1].trim();
                                    diet = diet.replace(/^(a |an |the |typically |primarily |mainly |various |a variety of )/g, '').trim();
                                    if (diet.length > 50) diet = diet.substring(0, 50) + '...'; 
                                } else {
                                    dietMatch = lowerCaseDescription.match(/(carnivore|herbivore|omnivore|insectivore|piscivore)s?/i);
                                    if (dietMatch) diet = dietMatch[0];
                                }


                                let lifespanMatch = lowerCaseDescription.match(/(?:lifespan is|life span is|lives for|can live for|live up to|longevity of)\s*([\d\s\w]+?\s*(?:years|year|months|month|days|day) of age)?/i);
                                if (lifespanMatch && lifespanMatch[1]) {
                                    lifespan = lifespanMatch[1].trim();
                                    if (lifespan.length > 30) lifespan = lifespan.substring(0, 30) + '...'; 
                                } else {
                                    lifespanMatch = lowerCaseDescription.match(/(\d+\s*(?:to\s*\d+\s*)?(?:years|year))/i);
                                    if (lifespanMatch && lifespanMatch[1]) {
                                        lifespan = lifespanMatch[1];
                                    } else {
                                        lifespanMatch = lowerCaseDescription.match(/(\d+\s*(?:to\s*\d+\s*)?(?:years|year|months|month|days|day) old)/i);
                                        if (lifespanMatch && lifespanMatch[1]) lifespan = lifespan[1];
                                    }
                                }


                                let habitatMatch = lowerCaseDescription.match(/(?:habitat is|found in|lives in|inhabits|native to|occurs in)(?: the)?\s*([\w\s,.\-()]+?)(?:\.|\n|;|,|$)/i);
                                if (habitatMatch && habitatMatch[1]) {
                                    habitat = habitatMatch[1].trim();
                                     if (habitat.length > 70) habitat = habitat.substring(0, 70) + '...'; 
                                } else {
                                    habitatMatch = lowerCaseDescription.match(/inhabits (.*?)(?:\.|\n|;|,|$)/i);
                                    if (habitatMatch && habitatMatch[1]) {
                                        habitat = habitatMatch[1].trim();
                                        if (habitat.length > 70) habitat = habitat.substring(0, 70) + '...'; 
                                    }
                                }

                                let locationMatch = lowerCaseDescription.match(/(native to|found across|distributed throughout|occurs in|range includes)(.*?)(?:\.|\n|;|,|$)/i);
                                if (locationMatch && locationMatch[2]) {
                                    let extractedLocations = locationMatch[2].trim().split(/,\s*|\s*and\s*|(?=\s*in\s*(?:the\s*)?[A-Z])/).map(loc => loc.trim()).filter(loc => loc.length > 0);
                                    if (extractedLocations.length > 0) {
                                        locations = extractedLocations.slice(0, 3);
                                        if (extractedLocations.length > 3) locations.push('...');
                                    }
                                }

                                return {
                                    name: animalName,
                                    taxonomy: {
                                        scientific_name: scientificName,
                                    },
                                    characteristics: {
                                        description: description,
                                        diet: diet,
                                        lifespan: lifespan,
                                        habitat: habitat
                                    },
                                    locations: locations,
                                    wikipedia_url: wikipediaUrl
                                };
                            }
                        }
                    } catch (error) {
                        console.error(`Error fetching animal details from Wikipedia for "${decodeURIComponent(queryTitle)}":`, error);
                    }
                }
                return null;
            }


            /** Shows the detail view and populates it with all animal info. */
            async function showDetailView(animal) {
                playClickSound();
                console.log("showDetailView function called for:", animal.name);
                mainView.classList.add('hidden');
                collectionContainer.classList.add('hidden');
                detailView.classList.remove('hidden');
                detailTitle.textContent = animal.name;
                detailContent.innerHTML = '';
                galleryGrid.innerHTML = '';
                galleryLoader.classList.remove('hidden');

                const iconMap = {
                    'locations': { icon: 'fa-map-marker-alt', color: 'text-red-500' },
                    'diet': { icon: 'fa-utensils', color: 'text-yellow-500' },
                    'lifespan': { icon: 'fa-heartbeat', color: 'text-green-500' },
                    'skin_type': { icon: 'fa-tshirt', color: 'text-blue-500' },
                    'habitat': { icon: 'fa-home', color: 'text-indigo-500' },
                    'top_speed': { icon: 'fa-tachometer-alt', color: 'text-purple-500' },
                    'weight': { icon: 'fa-weight-hanging', color: 'text-orange-500' },
                    'height': { icon: 'fa-ruler-vertical', color: 'text-pink-500' },
                    'default': { icon: 'fa-info-circle', color: 'text-gray-500' }
                };

                let characteristicsHtml = '';
                if (animal.characteristics && Object.keys(animal.characteristics).length > 0) {
                    characteristicsHtml += '<div class="space-y-4 text-gray-800 dark:text-gray-200">';
                    if (animal.locations && animal.locations.length > 0 && animal.locations[0] !== 'Not specified') {
                        const iconInfo = iconMap['locations'] || iconMap['default'];
                        characteristicsHtml += `<p><i class="fas ${iconInfo.icon} w-6 ${iconInfo.color}"></i> <strong class="font-semibold">Locations:</strong> ${animal.locations.join(', ')}</p>`;
                    }
                    if (animal.characteristics.description) {
                        characteristicsHtml += `<p><i class="fas fa-info-circle w-6 text-gray-500"></i> <strong class="font-semibold">Description:</strong> ${animal.characteristics.description}</p>`;
                    }
                    const characteristicsToDisplay = ['diet', 'lifespan', 'habitat', 'skin_type', 'top_speed', 'weight', 'height'];
                    characteristicsToDisplay.forEach(key => {
                        const value = animal.characteristics[key];
                        if (value && value.toString().trim() !== '' && value.toString().toLowerCase() !== 'not specified' && key !== 'description') {
                            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const iconInfo = iconMap[key] || iconMap['default'];
                            characteristicsHtml += `<p><i class="fas ${iconInfo.icon} w-6 ${iconInfo.color}"></i> <strong class="font-semibold">${label}:</strong> ${value}</p>`;
                        }
                    });
                    characteristicsHtml += '</div>';
                }

                let taxonomyHtml = '';
                if (animal.taxonomy && Object.keys(animal.taxonomy).length > 1) {
                    taxonomyHtml += '<div class="space-y-4 text-gray-800 dark:text-gray-200">';
                    for (const [key, value] of Object.entries(animal.taxonomy)) {
                        if (key !== 'scientific_name' && value) {
                            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const iconInfo = iconMap['default'];
                            taxonomyHtml += `<p><i class="fas fa-sitemap w-6 text-gray-500"></i> <strong class="font-semibold">${label}:</strong> ${value}</p>`;
                        }
                    }
                    taxonomyHtml += '</div>';
                }
                
                detailContent.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-teal-700 dark:text-teal-300 mb-3">Characteristics</h3>
                        ${characteristicsHtml || '<p>No characteristics available.</p>'}
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-teal-700 dark:text-teal-300 mb-3">Classification</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-3 italic">${animal.taxonomy?.scientific_name || ''}</p>
                        ${taxonomyHtml || '<p>No classification data available.</p>'}
                    </div>
                `;

                if (animal.wikipedia_url) {
                    detailContent.insertAdjacentHTML('beforeend', `
                        <div class="col-span-full mt-8 text-center">
                            <a href="${animal.wikipedia_url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition">
                                Read Full Wikipedia Article <i class="fas fa-external-link-alt ml-2"></i>
                            </a>
                        </div>
                    `);
                }


                const images = await fetchAllGalleryImages(animal.name);
                galleryLoader.classList.add('hidden');
                if (images.length === 0) {
                    galleryGrid.innerHTML = '<p class="col-span-full text-center text-gray-600 dark:text-gray-400">No additional photos could be found from Pexels or Wikipedia.</p>';
                } else {
                    images.forEach(imgUrl => {
                        const imgElement = document.createElement('img');
                        imgElement.src = imgUrl;
                        imgElement.alt = `Photo of a ${animal.name}`;
                        imgElement.className = 'w-full h-full object-cover rounded-lg shadow-md cursor-pointer';
                        imgElement.onerror = "this.onerror=null;this.src='https://placehold.co/400x300/e0e0e0/555555?text=Image+Load+Error';";
                        
                        imgElement.addEventListener('click', () => {
                            window.open(imgUrl, '_blank');
                        });

                        galleryGrid.appendChild(imgElement);
                    });
                }
            }
            
            /** Displays a message to the user. */
            function displayMessage(message) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
            }

            /** Hides the message box. */
            function hideMessage() {
                messageBox.classList.add('hidden');
            }

            // --- Initial Setup on page load ---
            const urlParams = new URLSearchParams(window.location.search);
            // CORRECTED: Get backendUrl from URL parameters
            const backendUrlParam = urlParams.get('backendUrl');
            const authTokenParam = urlParams.get('authToken');
            const userDataParam = urlParams.get('userData');
            
            // Set the backend URL from the parameter, if available
            if (backendUrlParam) {
                BACKEND_BASE_URL = backendUrlParam;
            } else {
                console.warn("Backend URL not provided in URL parameters. API calls may fail.");
            }
            
            // If auth data is in URL, store it in local storage
            if (authTokenParam && userDataParam) {
                localStorage.setItem('token', authTokenParam);
                localStorage.setItem('user', userDataParam);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
